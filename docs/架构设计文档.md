# AI 角色扮演互动平台 - 架构设计文档

## 目录
1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [技术栈](#技术栈)
4. [模块详细设计](#模块详细设计)
5. [数据库设计](#数据库设计)
6. [API 接口设计](#api-接口设计)
7. [部署架构](#部署架构)
8. [运行说明](#运行说明)
9. [开发环境配置](#开发环境配置)
10. [生产环境部署](#生产环境部署)
11. [性能优化](#性能优化)
12. [安全考虑](#安全考虑)
13. [监控与日志](#监控与日志)
14. [扩展性设计](#扩展性设计)

---

## 项目概述

### 项目简介
AI 角色扮演互动平台是一个基于先进 AI 大模型技术的语音角色扮演聊天 Web 应用。用户可以与各种虚拟角色（如小说人物、历史人物、影视角色等）进行实时、自然的语音对话，获得独特的沉浸式互动体验。

### 核心特性
- 🎭 **多角色支持**：支持多种预设角色，每个角色都有独特的性格和对话风格
- 🎤 **语音交互**：支持语音输入和语音输出，提供自然的对话体验
- 💬 **实时聊天**：基于 WebSocket 的实时消息传递
- 🔐 **用户系统**：完整的用户注册、登录、个人资料管理
- 📱 **响应式设计**：适配各种设备尺寸
- 🎨 **现代化 UI**：基于 Vue 3 的现代化用户界面

### 技术亮点
- 微服务架构设计
- 容器化部署
- 实时语音处理
- AI 大模型集成
- 现代化前端框架

---

## 系统架构

### 整体架构图

```mermaid
graph TB
    subgraph "用户层"
        U1[Web 浏览器]
        U2[移动端浏览器]
    end
    
    subgraph "前端层"
        F1[Vue 3 应用]
        F2[语音录制组件]
        F3[音频播放组件]
    end
    
    subgraph "API 网关层"
        G1[Nginx 反向代理]
        G2[负载均衡器]
    end
    
    subgraph "后端服务层"
        B1[Go 主服务]
        B2[C++ 扩展服务]
        B3[语音处理服务]
    end
    
    subgraph "AI 服务层"
        A1[OpenRouter API]
        A2[百度智能云 ASR]
        A3[百度智能云 TTS]
    end
    
    subgraph "数据层"
        D1[PostgreSQL 数据库]
        D2[Redis 缓存]
        D3[文件存储]
    end
    
    U1 --> F1
    U2 --> F1
    F1 --> G1
    F2 --> B3
    F3 --> B3
    G1 --> B1
    G1 --> B2
    B1 --> A1
    B1 --> A2
    B1 --> A3
    B1 --> D1
    B1 --> D2
    B2 --> D1
    B3 --> D3
```

### 架构分层说明

#### 1. 用户层
- **Web 浏览器**：主要用户界面，支持现代浏览器
- **移动端浏览器**：响应式设计，支持移动设备访问

#### 2. 前端层
- **Vue 3 应用**：基于 Vue 3 + TypeScript 的单页应用
- **语音录制组件**：处理用户语音输入
- **音频播放组件**：播放 AI 角色语音回复

#### 3. API 网关层
- **Nginx 反向代理**：请求路由和负载均衡
- **负载均衡器**：多实例负载分发

#### 4. 后端服务层
- **Go 主服务**：核心业务逻辑处理
- **C++ 扩展服务**：高性能计算任务
- **语音处理服务**：语音识别和合成

#### 5. AI 服务层
- **OpenRouter API**：大语言模型服务
- **百度智能云 ASR**：语音识别服务
- **百度智能云 TTS**：语音合成服务

#### 6. 数据层
- **PostgreSQL**：主数据库，存储用户、角色、对话数据
- **Redis**：缓存和会话存储
- **文件存储**：音频文件存储

---

## 技术栈

### 前端技术栈
| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| Vue 3 | 3.5.21 | 前端框架 | 组合式 API，响应式系统 |
| TypeScript | 5.8.0 | 类型系统 | 提供类型安全和更好的开发体验 |
| Vite | 7.0.6 | 构建工具 | 快速开发和构建 |
| Vue Router | 4.5.1 | 路由管理 | 单页应用路由 |
| Axios | 1.12.2 | HTTP 客户端 | API 请求处理 |
| ESLint | 10.3.0 | 代码检查 | 代码质量保证 |
| Prettier | 3.6.2 | 代码格式化 | 代码风格统一 |

### 后端技术栈
| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| Go | 1.24.4 | 主后端语言 | 高性能并发处理 |
| C++ | C++17 | 扩展服务 | 高性能计算任务 |
| PostgreSQL | 16+ | 主数据库 | 关系型数据存储 |
| Redis | 7+ | 缓存 | 会话和缓存存储 |
| Docker | 最新 | 容器化 | 服务容器化部署 |
| Docker Compose | 3.9 | 编排工具 | 多服务编排 |

### AI 服务技术栈
| 服务 | 用途 | 说明 |
|------|------|------|
| OpenRouter | 大语言模型 | 提供多种 AI 模型访问 |
| 百度智能云 ASR | 语音识别 | 将语音转换为文本 |
| 百度智能云 TTS | 语音合成 | 将文本转换为语音 |

---

## 模块详细设计

### 1. 前端模块 (Frontend Module)

#### 1.1 模块概述
前端模块基于 Vue 3 + TypeScript 构建，提供现代化的用户界面和交互体验。

#### 1.2 目录结构
```
frontend/
├── src/
│   ├── components/          # 可复用组件
│   │   └── AppHeader.vue   # 应用头部组件
│   ├── views/              # 页面视图
│   │   ├── auth/           # 认证相关页面
│   │   │   ├── LoginView.vue
│   │   │   └── RegisterView.vue
│   │   ├── chat/           # 聊天相关页面
│   │   │   └── ChatView.vue
│   │   ├── home/           # 首页相关页面
│   │   │   └── RoleSelectView.vue
│   │   └── profile/        # 个人资料页面
│   │       ├── authProfile.vue
│   │       └── roleProfile.vue
│   ├── router/             # 路由配置
│   │   └── index.ts
│   ├── services/           # API 服务
│   │   └── api.ts
│   ├── types/              # TypeScript 类型定义
│   │   └── api.ts
│   ├── utils/              # 工具函数
│   │   └── request.ts
│   ├── plugins/            # 插件配置
│   │   └── axios.ts
│   ├── App.vue             # 根组件
│   └── main.ts             # 应用入口
├── public/                 # 静态资源
├── package.json            # 依赖配置
├── vite.config.ts          # Vite 配置
├── tsconfig.json           # TypeScript 配置
└── eslint.config.ts        # ESLint 配置
```

#### 1.3 核心组件设计

##### 1.3.1 角色选择页面 (RoleSelectView.vue)
**功能**：展示可用角色列表，用户可以选择角色开始对话
**特性**：
- 响应式角色卡片布局
- 角色搜索和筛选
- 用户认证状态管理
- 路由导航

##### 1.3.2 聊天页面 (ChatView.vue)
**功能**：与选定角色进行实时对话
**特性**：
- 实时消息显示
- 语音录制和播放
- 消息历史记录
- 角色信息展示

##### 1.3.3 认证页面 (LoginView.vue, RegisterView.vue)
**功能**：用户注册和登录
**特性**：
- 表单验证
- 错误处理
- 自动登录状态管理

#### 1.4 状态管理
- 使用 Vue 3 的 Composition API 进行状态管理
- 全局状态通过 provide/inject 或 Pinia 管理
- 本地状态使用 ref/reactive

#### 1.5 路由设计
```typescript
const routes = [
  { path: '/', name: 'roleSelect', component: RoleSelectView },
  { path: '/chat/:roleId', name: 'chat', component: ChatView },
  { path: '/login', name: 'login', component: LoginView },
  { path: '/register', name: 'register', component: RegisterView },
  { path: '/profile', name: 'profile', component: AuthProfile },
  { path: '/role/:roleId', name: 'roleProfile', component: RoleProfile }
]
```

#### 1.6 API 集成
- 使用 Axios 进行 HTTP 请求
- 统一的请求拦截器和响应拦截器
- 错误处理和重试机制
- 请求取消和超时处理

### 2. 后端模块 (Backend Module)

#### 2.1 模块概述
后端模块基于 Go 语言构建，提供 RESTful API 和 WebSocket 服务，处理业务逻辑和数据管理。

#### 2.2 目录结构
```
backend-go/
├── cmd/
│   └── server/
│       └── main.go         # 应用入口
├── internal/
│   ├── app/
│   │   └── deps.go         # 依赖注入
│   ├── config/
│   │   └── config.go       # 配置管理
│   ├── handlers/           # HTTP 处理器
│   │   ├── auth.go         # 认证处理
│   │   ├── chat.go         # 聊天处理
│   │   ├── roles.go        # 角色管理
│   │   ├── asr.go          # 语音识别
│   │   ├── tts.go          # 语音合成
│   │   └── ...
│   ├── middleware/         # 中间件
│   │   ├── auth.go         # JWT 认证
│   │   ├── logging.go      # 日志记录
│   │   └── ratelimit.go    # 限流控制
│   ├── models/             # 数据模型
│   │   └── types.go        # 类型定义
│   ├── repo/               # 数据访问层
│   │   ├── db/             # 数据库实现
│   │   ├── memory/         # 内存实现
│   │   └── repo.go         # 接口定义
│   ├── services/           # 业务服务
│   │   ├── model.go        # AI 模型服务
│   │   ├── asr.go          # 语音识别服务
│   │   └── tts.go          # 语音合成服务
│   └── security/
│       └── jwt.go          # JWT 处理
├── speech/                 # 语音处理工具
├── tools/                  # 开发工具
├── go.mod                  # Go 模块配置
├── go.sum                  # 依赖锁定
└── Dockerfile              # Docker 配置
```

#### 2.3 核心服务设计

##### 2.3.1 认证服务 (Auth Service)
**功能**：用户注册、登录、JWT 令牌管理
**实现**：
- 密码哈希和验证
- JWT 令牌生成和验证
- 用户会话管理

##### 2.3.2 聊天服务 (Chat Service)
**功能**：处理用户与角色的对话
**实现**：
- 消息接收和存储
- AI 模型调用
- 响应生成和返回

##### 2.3.3 角色管理服务 (Role Service)
**功能**：管理角色信息和配置
**实现**：
- 角色列表获取
- 角色详情查询
- 角色提示词管理

##### 2.3.4 语音处理服务 (Speech Service)
**功能**：语音识别和语音合成
**实现**：
- 音频文件处理
- 百度智能云 API 集成
- 音频格式转换

#### 2.4 数据访问层设计
- 使用 Repository 模式
- 支持数据库和内存两种实现
- 统一的接口定义
- 事务管理

#### 2.5 中间件设计
- **认证中间件**：JWT 令牌验证
- **日志中间件**：请求日志记录
- **限流中间件**：API 调用频率限制
- **CORS 中间件**：跨域请求处理

### 3. 大模型模块 (AI Model Module)

#### 3.1 模块概述
大模型模块负责集成各种 AI 服务，提供智能对话能力。

#### 3.2 服务提供商

##### 3.2.1 OpenRouter 集成
**功能**：提供多种大语言模型访问
**配置**：
```go
type OpenRouterProvider struct {
    APIKey  string
    BaseURL string
    Model   string
    Client  *http.Client
}
```

**支持的模型**：
- nvidia/nemotron-nano-9b-v2:free
- 其他 OpenRouter 支持的模型

##### 3.2.2 百度智能云集成
**功能**：语音识别和语音合成
**服务**：
- ASR (Automatic Speech Recognition)
- TTS (Text-to-Speech)

#### 3.3 模型路由设计
```go
type ProviderRouter struct{}

func (r ProviderRouter) ResolveProvider(roleID string) ModelProvider {
    // 根据角色 ID 选择合适的模型提供商
    // 支持多种模型切换
}
```

#### 3.4 角色提示词管理
- 每个角色都有独特的提示词
- 支持动态更新角色提示词
- 提示词版本管理

---

## 数据库设计

### 数据库架构
使用 PostgreSQL 作为主数据库，支持 ACID 事务和复杂查询。

### 表结构设计

#### 1. 用户表 (users)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    avatar_url TEXT,
    bio TEXT
);
```

#### 2. 角色表 (roles)
```sql
CREATE TABLE roles (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    avatar_url TEXT,
    description TEXT,
    prompt TEXT,
    image_url TEXT
);
```

#### 3. 对话表 (conversations)
```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role_id TEXT NOT NULL REFERENCES roles(id) ON DELETE RESTRICT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

#### 4. 消息表 (messages)
```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    sender TEXT NOT NULL CHECK (sender IN ('user','role')),
    text TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

#### 5. 好友表 (friends)
```sql
CREATE TABLE friends (
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    friend_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    PRIMARY KEY(user_id, friend_user_id)
);
```

### 索引设计
```sql
-- 性能优化索引
CREATE INDEX idx_conversations_user ON conversations(user_id);
CREATE INDEX idx_messages_conv ON messages(conversation_id, created_at DESC);
```

---

## API 接口设计

### RESTful API 规范

#### 1. 认证接口
```
POST /api/auth/login      # 用户登录
POST /api/auth/register   # 用户注册
```

#### 2. 角色接口
```
GET  /api/roles           # 获取角色列表
GET  /api/roles/{id}      # 获取角色详情
POST /api/roles/create    # 创建角色
PUT  /api/roles/prompt/{id} # 更新角色提示词
```

#### 3. 聊天接口
```
POST /api/chat            # 发送消息
POST /api/chat/stream     # 流式聊天
```

#### 4. 语音接口
```
POST /api/asr             # 语音识别
POST /api/tts             # 语音合成
POST /api/upload/audio    # 音频上传
```

#### 5. 用户接口
```
GET  /api/user/me         # 获取用户信息
PUT  /api/user/avatar     # 更新头像
PUT  /api/user/bio        # 更新个人简介
GET  /api/user/friends    # 获取好友列表
POST /api/user/friends/add # 添加好友
DELETE /api/user/friends/{id} # 删除好友
```

#### 6. 对话接口
```
GET  /api/conversations   # 获取对话列表
GET  /api/messages        # 获取消息列表
```

### WebSocket 接口
```
ws://localhost:8080/ws/chat/{conversationId}
```

---

## 部署架构

### Docker 容器化部署

#### 1. 服务容器
- **frontend**: Vue 3 应用容器
- **backend-go**: Go 后端服务容器
- **backend-cpp**: C++ 扩展服务容器
- **postgres**: PostgreSQL 数据库容器
- **redis**: Redis 缓存容器
- **nginx**: 反向代理容器

#### 2. Docker Compose 配置
```yaml
version: '3.9'
services:
  frontend:
    build: ./frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_API_BASE=http://localhost:8080
    depends_on:
      - backend-go

  backend-go:
    build: ./backend-go
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=${DATABASE_URL}
    depends_on:
      - postgres

  postgres:
    image: postgres:16
    environment:
      - POSTGRES_PASSWORD=123456
      - POSTGRES_DB=mydb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

---

## 运行说明

### 快速开始

#### 1. 环境要求
- Node.js 20.19.0+ 或 22.12.0+
- Go 1.24.4+
- PostgreSQL 16+
- Docker & Docker Compose (可选)

#### 2. 克隆项目
```bash
git clone <repository-url>
cd AI-role-playing-interactive-platform
```

#### 3. 数据库设置
```bash
# 安装 PostgreSQL
# 创建数据库
createdb mydb

# 导入数据库结构
psql -d mydb -f database/schema.sql
```

#### 4. 后端启动
```bash
cd backend-go
go mod download
go run ./cmd/server
```

#### 5. 前端启动
```bash
cd frontend
npm install
npm run dev
```

#### 6. 访问应用
- 前端: http://localhost:5173
- 后端 API: http://localhost:8080
- API 文档: http://localhost:8080/api/docs

### Docker 部署

#### 1. 使用 Docker Compose
```bash
# 启动所有服务
docker-compose up --build

# 后台运行
docker-compose up -d --build

# 停止服务
docker-compose down
```

#### 2. 环境变量配置
创建 `.env` 文件：
```env
# 数据库配置
DATABASE_URL=postgres://postgres:123456@localhost:5432/mydb?sslmode=disable

# JWT 配置
JWT_SECRET=your-secret-key

# CORS 配置
ALLOWED_ORIGINS=*

# OpenRouter 配置
OPENROUTER_API_KEY=your-api-key
OPENROUTER_MODEL=nvidia/nemotron-nano-9b-v2:free

# 百度智能云配置
BAIDU_APP_ID=your-app-id
BAIDU_API_KEY=your-api-key
BAIDU_SECRET_KEY=your-secret-key
```

---

## 开发环境配置

### 1. 前端开发环境

#### 1.1 安装依赖
```bash
cd frontend
npm install
```

#### 1.2 开发服务器
```bash
npm run dev
```

#### 1.3 代码检查
```bash
npm run lint
npm run format
```

#### 1.4 构建生产版本
```bash
npm run build
```

### 2. 后端开发环境

#### 2.1 安装 Go 依赖
```bash
cd backend-go
go mod download
```

#### 2.2 运行开发服务器
```bash
go run ./cmd/server
```

#### 2.3 代码检查
```bash
go vet ./...
go fmt ./...
```

#### 2.4 构建可执行文件
```bash
go build -o server ./cmd/server
```

### 3. 数据库开发

#### 3.1 数据库迁移
```bash
# 应用迁移
go run ./cmd/migrate

# 回滚迁移
go run ./cmd/rollback
```

#### 3.2 数据库重置
```bash
# 删除并重建数据库
dropdb mydb
createdb mydb
psql -d mydb -f database/schema.sql
```

---

## 生产环境部署

### 1. 服务器要求
- CPU: 4+ 核心
- 内存: 8GB+
- 存储: 100GB+ SSD
- 网络: 100Mbps+

### 2. 部署步骤

#### 2.1 服务器准备
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### 2.2 应用部署
```bash
# 克隆代码
git clone <repository-url>
cd AI-role-playing-interactive-platform

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 启动服务
docker-compose up -d --build
```

#### 2.3 Nginx 配置
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:5173;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 2.4 SSL 配置
```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取 SSL 证书
sudo certbot --nginx -d your-domain.com
```

### 3. 监控和日志

#### 3.1 日志管理
```bash
# 查看容器日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend-go
```

#### 3.2 性能监控
- 使用 Prometheus + Grafana 监控
- 配置告警规则
- 监控 CPU、内存、磁盘使用率

---

## 性能优化

### 1. 前端优化

#### 1.1 代码分割
```typescript
// 路由懒加载
const ChatView = () => import('@/views/chat/ChatView.vue')
```

#### 1.2 资源优化
- 图片压缩和懒加载
- CSS/JS 文件压缩
- CDN 加速

#### 1.3 缓存策略
- 浏览器缓存
- Service Worker
- 本地存储

### 2. 后端优化

#### 2.1 数据库优化
- 索引优化
- 查询优化
- 连接池配置

#### 2.2 缓存策略
- Redis 缓存
- 内存缓存
- 查询结果缓存

#### 2.3 并发优化
- Goroutine 池
- 连接池
- 限流控制

### 3. AI 服务优化

#### 3.1 模型优化
- 模型选择
- 参数调优
- 批量处理

#### 3.2 响应优化
- 流式响应
- 缓存机制
- 超时控制

---

## 安全考虑

### 1. 认证安全
- JWT 令牌安全
- 密码加密存储
- 会话管理

### 2. API 安全
- 输入验证
- SQL 注入防护
- XSS 防护
- CSRF 防护

### 3. 数据安全
- 数据加密
- 访问控制
- 审计日志

### 4. 网络安全
- HTTPS 加密
- 防火墙配置
- DDoS 防护

---

## 监控与日志

### 1. 应用监控
- 性能指标监控
- 错误率监控
- 响应时间监控

### 2. 系统监控
- 服务器资源监控
- 数据库性能监控
- 网络流量监控

### 3. 日志管理
- 结构化日志
- 日志聚合
- 日志分析

### 4. 告警系统
- 异常告警
- 性能告警
- 安全告警

---

## 扩展性设计

### 1. 水平扩展
- 无状态服务设计
- 负载均衡
- 数据库分片

### 2. 垂直扩展
- 资源升级
- 性能调优
- 缓存优化

### 3. 微服务拆分
- 服务边界定义
- 服务间通信
- 数据一致性

### 4. 云原生架构
- 容器编排
- 服务网格
- 云服务集成

---

## 总结

本架构设计文档详细描述了 AI 角色扮演互动平台的完整技术架构，包括：

1. **模块分工**：
   - 前端模块：负责用户界面和交互
   - 后端模块：负责业务逻辑和数据处理
   - 大模型模块：负责 AI 能力提供

2. **技术选型**：基于现代化的技术栈，确保高性能和可维护性

3. **部署方案**：支持开发、测试、生产多种环境部署

4. **扩展性**：设计考虑了未来的扩展需求

5. **安全性**：全面的安全考虑和防护措施

该平台为用户提供了沉浸式的 AI 角色扮演体验，通过先进的技术架构确保了系统的稳定性、性能和可扩展性。

---

*文档版本：v1.0*  
*最后更新：2024年12月*  
*维护者：开发团队*
