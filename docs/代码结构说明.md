## 代码结构说明（文件作用与依赖关系）

本文档概述仓库中主要目录与文件的职责，并说明它们之间的调用关系，便于新成员快速理解工程结构。

### 根目录
- `README.md`：项目概述、目录说明、启动指引。
- `.gitignore`：版本控制忽略规则。
- `docker-compose.yml`：本地/开发编排（前端、Go 后端、C++ stub）。
- `database/schema.sql`：PostgreSQL 初版建表脚本（roles/users/conversations/messages）。

### api/
- `api/openapi.yaml`：OpenAPI 3 规范，描述已提供的 HTTP API：
  - 角色：`GET /api/roles`、`GET /api/roles/{id}`
  - 聊天：`POST /api/chat`、`POST /api/chat/stream`（SSE 占位）
  - ASR/TTS：`POST /api/asr`、`POST /api/tts`（占位）
  - 认证：`POST /api/auth/login`（占位）
  - 会话/消息：`GET /api/conversations`、`GET /api/messages`

依赖关系：此文件为接口契约，前端与后端实现应与其保持一致。

### frontend/（Vite + React + TS）
- `vite.config.ts`：Vite 配置；开发代理 `/api` 到后端 8080。
- `Dockerfile`：前端构建与 Nginx 发布镜像。
- `src/App.tsx`：最小可用界面：角色选择、文本聊天、录音占位；调用 `/api/roles`、`/api/chat`。
- `src/App.css`：简单样式。

依赖关系：
- 通过浏览器发起请求到后端 API；代理规则在 `vite.config.ts` 中配置。

### backend-go/
- `Dockerfile`：Go 服务镜像（多阶段构建）。

#### cmd/server/
- `main.go`：应用入口，职责：
  - 加载配置（`internal/config`）。
  - 注册路由（`internal/handlers`）。
  - 挂载中间件（`internal/middleware`），设置 CORS。
  - 启动 HTTP 服务器。

依赖关系：
- 直接依赖 `handlers`、`middleware`、`config` 包。

#### internal/config/
- `config.go`：配置加载（环境变量），含端口、JWT 密钥、允许跨域来源等。

#### internal/models/
- `types.go`：领域模型：`Role`、`ChatRequest`、`ChatResponse`。

#### internal/httpX/
- `error.go`：统一错误返回结构与写入方法（`ErrorResponse`）。

#### internal/middleware/
- `logging.go`：简单访问日志中间件（记录方法、路径、耗时）。
- `auth.go`：JWT 鉴权占位（检查 Bearer Token 是否存在）。

依赖关系：
- 在 `cmd/server/main.go` 中统一挂载。

#### internal/repo/
- `repo.go`：仓储接口定义：
  - `RoleRepository`：角色列表与查询。
  - `UserRepository`：用户创建/查询（占位）。
  - `ConversationRepository`、`MessageRepository`：会话与消息查询（占位）。

##### internal/repo/memory/
- `role_repo.go`：内存版角色仓储，实现 `RoleRepository`（由内置样例角色初始化）。
- `conversation_repo.go`：内存版会话仓储，占位返回空集合。
- `message_repo.go`：内存版消息仓储，占位返回空集合。

依赖关系：
- `handlers/roles.go` 使用 `RoleRepository` 读取角色数据；默认绑定为内存实现。

#### internal/services/
- `model.go`：大模型调用抽象：
  - `ModelProvider` 接口（`Generate`）。
  - `MockProvider` 占位实现。
  - `ProviderRouter`：按角色路由到 Provider（当前统一返回 Mock）。
- `asr.go`：ASR 占位服务接口（`TranscribeAudio`）。
- `tts.go`：TTS 占位服务接口（`SynthesizeSpeech`）。

依赖关系：
- `handlers/chat.go` 调用 `ProviderRouter` 解析 provider 并生成回复。
- `handlers/asr.go`、`handlers/tts.go` 分别调用 ASR/TTS 占位方法。

#### internal/handlers/
- `roles.go`：
  - `GET /api/roles`：通过 `RoleRepository` 返回角色列表。
  - `GET /api/roles/{id}`：返回单个角色信息。
- `chat.go`：
  - `POST /api/chat`：文本聊天，同步返回占位文本。
  - `POST /api/chat/stream`：SSE 流式占位，演示分块发送。
- `asr.go`：`POST /api/asr` 占位，返回空转写结果。
- `tts.go`：`POST /api/tts` 占位，返回空音频 URL。
- `auth.go`：`POST /api/auth/login` 占位，返回示例 Token。
- `conversation.go`：`GET /api/conversations` 占位，返回空集合。
- `message.go`：`GET /api/messages` 占位，返回空集合。

依赖关系：
- `handlers` 调用 `services`（模型/ASR/TTS）与 `repo`（数据访问）。
- `main.go` 将中间件应用在 `handlers` 之前。

### backend-cpp/
- `main.cpp`：极简 TCP 服务器，固定返回 `200 ok`（演示用途）。
- `CMakeLists.txt`：CMake 构建配置。
- `Dockerfile`：C++ stub 镜像。

依赖关系：
- 与 Go 后端无直接调用关系，仅作为扩展示例/占位组件。

### docs/
- `模块功能说明.md`：模块现有功能说明（前端/后端/大模型）。
- `代码结构说明.md`：本文档（文件职责与依赖关系）。

### 关键依赖关系总览
- 前端 → 后端：通过 `/api/*` HTTP 调用（开发模式由 Vite 代理）。
- 后端 `handlers` → `services`：聊天/ASR/TTS 逻辑抽象与实现。
- 后端 `handlers` → `repo`：数据读写抽象；现为内存实现，可替换为 DB。
- 后端入口 `main.go` → `config`/`middleware`/`handlers`：加载配置、装配路由与中间件、启动服务。
- OpenAPI → 前后端：作为接口契约来源，应保持与实际实现一致。

### 后续扩展指引（与本文档相关）
- 当接入数据库时：新增 `internal/repo/db/*` 实现；在 `roles.go` 等处通过依赖注入替换默认的内存实现。
- 当接入真实大模型/ASR/TTS 时：在 `internal/services` 中新增 Provider 实现，并在 `ProviderRouter`/对应 handler 中路由。
- 若新增端点：先更新 `api/openapi.yaml`，再实现 handler 与单元测试，并在本文档补充文件说明。


